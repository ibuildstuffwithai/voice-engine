<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClaw Voice</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --orange:rgb(245,124,0);
  --orange-light:rgb(255,152,0);
  --orange-dark:rgb(230,81,0);
  --orange-glow:rgba(245,124,0,.15);
  --orange-subtle:rgba(245,124,0,.06);
  --bg:#f0f0f0;
  --surface:#141414;
  --surface2:#1c1c1e;
  --border:#2a2a2e;
  --border-light:#3a3a3e;
  --text:#f5f5f5;
  --text-dim:#8e8e93;
  --text-muted:#636366;
  --radius:14px;
}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;align-items:center}
button{font-family:inherit;cursor:pointer;border:none;outline:none}
input,select,textarea{font-family:inherit;outline:none}

/* Noise texture removed for white bg */

/* Header - removed, title is inside the card now */
.header{display:none}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--orange),var(--orange-dark));display:flex;align-items:center;justify-content:center}
.logo-icon svg{width:18px;height:18px;fill:#fff}
.header h1{font-size:17px;font-weight:700;letter-spacing:-0.3px;color:#171717}
.header h1 span{color:#999;font-weight:400;margin-left:4px}
.header-right{display:flex;align-items:center;gap:8px}
.header-link{font-size:13px;font-weight:500;color:#999;padding:7px 14px;border-radius:8px;text-decoration:none;transition:all .15s}
.header-link:hover{background:#f0f0f0;color:#171717}
.gear-btn{width:36px;height:36px;border-radius:8px;background:transparent;display:flex;align-items:center;justify-content:center;transition:background .15s}
.gear-btn:hover{background:#f0f0f0}
.gear-btn svg{width:18px;height:18px;color:#999}

/* Main */
.main{width:100%;max-width:720px;padding:48px 24px 60px}

/* Card */
.card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:36px 40px;box-shadow:0 8px 32px rgba(0,0,0,.2)}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px}
.card-title{display:flex;align-items:center;gap:10px}
.card-title .logo-icon{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,rgb(245,124,0),rgb(230,81,0));display:flex;align-items:center;justify-content:center;flex-shrink:0}
.card-title .logo-icon svg{width:16px;height:16px;fill:#fff}
.card-title h1{font-size:18px;font-weight:700;letter-spacing:-0.3px;color:var(--text);margin:0}
.card-actions{display:flex;align-items:center;gap:6px}
.status-inline{display:flex;align-items:center;gap:5px;margin-right:8px}
.icon-btn{width:34px;height:34px;border-radius:8px;background:transparent;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .15s;color:var(--text-dim);text-decoration:none}
.icon-btn:hover{background:var(--surface2)}

/* Form */
.fg{margin-bottom:28px}
.fg label{display:block;font-size:12px;font-weight:600;color:var(--text-dim);margin-bottom:8px;letter-spacing:.04em;text-transform:uppercase}
.fg select,.fg textarea,.fg input[type=text],.fg input[type=password]{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;background:var(--surface2);color:var(--text);transition:border .15s,box-shadow .15s}
.fg select:focus,.fg textarea:focus,.fg input:focus{border-color:var(--orange);box-shadow:0 0 0 3px var(--orange-glow)}
.fg textarea{resize:vertical;min-height:80px}
.fg .hint{font-size:11px;color:var(--text-muted);margin-top:6px}

/* Presets */
.presets{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
.preset-btn{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:500;background:var(--surface2);color:var(--text-dim);border:1px solid var(--border);transition:all .15s}
.preset-btn:hover{background:var(--border);color:var(--text)}
.preset-btn.active{background:var(--orange);color:#fff;border-color:var(--orange)}

/* Connect button */
.connect-btn{width:100%;padding:16px;border-radius:var(--radius);font-size:15px;font-weight:700;background:linear-gradient(135deg,var(--orange),var(--orange-dark));color:#fff;transition:all .2s;letter-spacing:-0.01em;text-transform:uppercase;letter-spacing:.05em}
.connect-btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(245,124,0,.3)}
.connect-btn:active{transform:translateY(0)}
.connect-btn:disabled{background:#333;color:#666;cursor:not-allowed;transform:none;box-shadow:none}
.connect-btn.active{background:linear-gradient(135deg,#dc2626,#b91c1c)}
.connect-btn.active:hover{box-shadow:0 8px 24px rgba(220,38,38,.3)}
.connect-btn.connecting{background:#555;pointer-events:none}

/* Status */
.status{text-align:center;margin-bottom:24px}
.status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;vertical-align:middle}
.status-text{font-size:13px;color:var(--text-dim);vertical-align:middle}
.status-dot.disconnected{background:#555}
.status-dot.connecting{background:var(--orange);animation:pulse 1s infinite}
.status-dot.connected{background:#34c759}
.status-dot.error{background:#ff453a}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* Call UI */
.call-ui{display:none;text-align:center}
.call-ui.visible{display:block}
.call-avatar{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--orange),var(--orange-dark));margin:0 auto 16px;display:flex;align-items:center;justify-content:center;box-shadow:0 0 40px rgba(245,124,0,.2)}
.call-avatar svg{width:36px;height:36px;fill:#fff}
.timer{font-size:40px;font-weight:700;letter-spacing:-1px;margin:8px 0;font-variant-numeric:tabular-nums;color:var(--text)}
.call-label{font-size:14px;color:var(--text-dim);margin-bottom:4px}
.call-voice{font-size:16px;font-weight:600;color:var(--orange-light);margin-bottom:20px}
.visualizer{height:72px;display:flex;align-items:center;justify-content:center;gap:3px;margin:24px 0}
.visualizer .bar{width:3px;border-radius:2px;background:var(--orange);transition:height .08s;height:6px;opacity:.7}
.call-actions{display:flex;gap:16px;justify-content:center;margin-top:28px}
.call-action-btn{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .15s}
.mute-btn{background:var(--surface2);border:1px solid var(--border)}
.mute-btn:hover{background:var(--border)}
.mute-btn svg{color:var(--text-dim)}
.mute-btn.muted{background:rgba(255,69,58,.15);border-color:rgba(255,69,58,.3)}
.mute-btn.muted svg{color:#ff453a}
.end-btn{background:#ff453a;border:none}
.end-btn:hover{background:#dc2626;transform:scale(1.05)}
.end-btn svg{color:#fff}

/* Voice Grid */
.voice-grid{display:flex;flex-direction:column;gap:16px}
.voice-section-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--text-muted);margin-bottom:2px}
.voice-section{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.voice-card{display:flex;align-items:center;gap:8px;padding:10px 12px;border:2px solid var(--border);border-radius:12px;background:var(--surface2);cursor:pointer;transition:all .15s;user-select:none}
.voice-card:hover{border-color:var(--border-light);background:var(--border)}
.voice-card.selected{border-color:var(--orange);background:var(--orange-subtle);box-shadow:0 0 0 1px var(--orange)}
.voice-card .vc-info{flex:1;min-width:0}
.voice-card .vc-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.voice-card .vc-style{font-size:11px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.voice-card .vc-play{width:28px;height:28px;border-radius:50%;background:var(--orange);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.voice-card .vc-play:hover{background:var(--orange-light);transform:scale(1.1)}
.voice-card .vc-play svg{width:12px;height:12px;color:#fff;fill:#fff}
.voice-card .vc-play.playing{background:#34c759}

/* Samples link */
.samples-link{display:inline-block;margin-top:12px;font-size:13px;color:var(--orange-light);text-decoration:none;font-weight:500;transition:color .15s}
.samples-link:hover{color:var(--orange);text-decoration:underline}

/* Settings Modal */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;backdrop-filter:blur(8px)}
.overlay.visible{display:flex;align-items:center;justify-content:center}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:32px;width:90%;max-width:440px;box-shadow:0 24px 80px rgba(0,0,0,.4)}
.modal h2{font-size:18px;font-weight:700;margin-bottom:24px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:28px}
.btn-secondary{padding:10px 20px;border-radius:10px;font-size:14px;font-weight:500;background:var(--surface2);color:var(--text-dim);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--border)}
.btn-primary{padding:10px 20px;border-radius:10px;font-size:14px;font-weight:600;background:var(--orange);color:#fff}
.btn-primary:hover{background:var(--orange-dark)}

/* Responsive */
@media(max-width:480px){.main{padding:24px 16px}.card{padding:24px 20px}}
</style>
</head>
<body>

<!-- header removed, title is inside the card -->

<div class="main">
  <div class="card" id="setupCard">
    <div class="card-header">
      <div class="card-title">
        <div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2" fill="none" stroke="#fff" stroke-width="2"/></svg></div>
        <h1>OpenClaw Voice</h1>
      </div>
      <div class="card-actions">
        <div class="status-inline">
          <span class="status-dot disconnected" id="statusDot"></span>
          <span class="status-text" id="statusText">Ready</span>
        </div>
        <a href="manage.html" class="icon-btn" title="Manage">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        </a>
        <button class="icon-btn" onclick="openSettings()" title="Settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        </button>
      </div>
    </div>

    <div class="fg">
      <label>Persona</label>
      <textarea id="personaInput" placeholder="Describe the AI persona...">You are a friendly and helpful AI assistant with a warm personality.</textarea>
      <div class="presets" id="presets">
        <button class="preset-btn active" data-persona="You are a friendly and helpful AI assistant with a warm personality.">Assistant</button>
        <button class="preset-btn" data-persona="You are a medical receptionist at a clinic. You help patients schedule appointments, answer basic questions about office hours, and triage urgency. Be calm and professional.">Medical</button>
        <button class="preset-btn" data-persona="You are a bank customer service agent. Help with account inquiries, transfers, and card issues. Verify identity before sharing sensitive info. Be professional and secure.">Bank</button>
        <button class="preset-btn" data-persona="You are an astronaut aboard the ISS. You describe what you see in space and answer questions about life in zero gravity. Be awe-inspired and scientific.">Astronaut</button>
        <button class="preset-btn" data-persona="">Custom</button>
      </div>
    </div>

    <div class="fg">
      <label>Voice</label>
      <select id="voiceSelect" style="display:none"></select>
      <div class="voice-grid" id="voiceGrid"></div>
      <a href="/samples.html" target="_blank" class="samples-link">üéôÔ∏è Preview all voice samples ‚Üí</a>
    </div>

    <button class="connect-btn" id="connectBtn" onclick="toggleCall()">Start Call</button>
  </div>

  <div class="call-ui" id="callUI">
    <div class="call-avatar">
      <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2" fill="none" stroke="#fff" stroke-width="2"/></svg>
    </div>
    <div class="status">
      <span class="status-dot connected" id="callStatusDot"></span>
      <span class="status-text" id="callStatusText">Connected</span>
    </div>
    <div class="timer" id="timer">00:00</div>
    <div class="call-label" id="callPersonaLabel"></div>
    <div class="call-voice" id="callVoiceLabel"></div>
    <div class="visualizer" id="visualizer"></div>
    <div class="call-actions">
      <button class="call-action-btn mute-btn" id="muteBtn" onclick="toggleMute()" title="Mute">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
      </button>
      <button class="call-action-btn end-btn" onclick="endCall()" title="End Call">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.68 13.31a16 16 0 003.41 2.6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7 2 2 0 011.72 2v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.79 19.79 0 012.12 4.18 2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 002.59 3.4z"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="overlay" id="settingsOverlay" onclick="closeSettingsOutside(event)">
  <div class="modal">
    <h2>‚öôÔ∏è Settings</h2>
    <div class="fg">
      <label>PersonaPlex Server URL</label>
      <input type="text" id="settingsServerUrl" placeholder="ws://localhost:8998 or wss://pod-id-8998.proxy.runpod.net">
      <div class="hint">WebSocket URL of the PersonaPlex backend</div>
    </div>
    <div class="fg">
      <label>HuggingFace Token</label>
      <input type="password" id="settingsHfToken" placeholder="hf_...">
      <div class="hint">Required for model access on RunPod</div>
    </div>
    <div class="fg">
      <label>RunPod API Key</label>
      <input type="password" id="settingsRunpodKey" placeholder="rp_...">
      <div class="hint">Optional ‚Äî for programmatic pod management</div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
      <button class="btn-primary" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<script>
let ws=null,audioContext=null,mediaStream=null,scriptProcessor=null,timerInterval=null,callSeconds=0,isMuted=false,isConnected=false;

function loadSettings(){return JSON.parse(localStorage.getItem('ve_settings')||'{}')}
function openSettings(){const s=loadSettings();document.getElementById('settingsServerUrl').value=s.serverUrl||'';document.getElementById('settingsHfToken').value=s.hfToken||'';document.getElementById('settingsRunpodKey').value=s.runpodKey||'';document.getElementById('settingsOverlay').classList.add('visible')}
function closeSettings(){document.getElementById('settingsOverlay').classList.remove('visible')}
function closeSettingsOutside(e){if(e.target===e.currentTarget)closeSettings()}
function saveSettings(){localStorage.setItem('ve_settings',JSON.stringify({serverUrl:document.getElementById('settingsServerUrl').value.trim(),hfToken:document.getElementById('settingsHfToken').value.trim(),runpodKey:document.getElementById('settingsRunpodKey').value.trim()}));closeSettings()}

const voices=[
{id:'NATF0',name:'Nova',style:'Warm, conversational',gender:'female',sample:true},
{id:'NATF1',name:'Aria',style:'Clear, professional',gender:'female',sample:true},
{id:'NATF2',name:'Luna',style:'Friendly, engaging',gender:'female',sample:true},
{id:'NATF3',name:'Sage',style:'Calm, thoughtful',gender:'female',sample:true},
{id:'NATM0',name:'Atlas',style:'Strong, confident',gender:'male',sample:true},
{id:'NATM1',name:'Orion',style:'Deep, authoritative',gender:'male',sample:true},
{id:'NATM2',name:'Felix',style:'Bright, energetic',gender:'male',sample:true},
{id:'NATM3',name:'Reed',style:'Smooth, relaxed',gender:'male',sample:true},
{id:'VARF0',name:'Vox-F0',style:'Variety',gender:'female',sample:false},
{id:'VARF1',name:'Vox-F1',style:'Variety',gender:'female',sample:false},
{id:'VARF2',name:'Vox-F2',style:'Variety',gender:'female',sample:false},
{id:'VARF3',name:'Vox-F3',style:'Variety',gender:'female',sample:false},
{id:'VARF4',name:'Vox-F4',style:'Variety',gender:'female',sample:false},
{id:'VARM0',name:'Vox-M0',style:'Variety',gender:'male',sample:false},
{id:'VARM1',name:'Vox-M1',style:'Variety',gender:'male',sample:false},
{id:'VARM2',name:'Vox-M2',style:'Variety',gender:'male',sample:false},
{id:'VARM3',name:'Vox-M3',style:'Variety',gender:'male',sample:false},
{id:'VARM4',name:'Vox-M4',style:'Variety',gender:'male',sample:false},
];

let selectedVoice='NATM2',previewAudio=null;

function populateVoices(){
const sel=document.getElementById('voiceSelect'),grid=document.getElementById('voiceGrid');
voices.forEach(v=>{const opt=document.createElement('option');opt.value=v.id;opt.textContent=v.name;sel.appendChild(opt)});
sel.value=selectedVoice;
const sections=[
{label:'‚ôÄ Natural Female',filter:v=>v.gender==='female'&&v.sample},
{label:'‚ôÇ Natural Male',filter:v=>v.gender==='male'&&v.sample},
{label:'‚ôÄ Variety Female',filter:v=>v.gender==='female'&&!v.sample},
{label:'‚ôÇ Variety Male',filter:v=>v.gender==='male'&&!v.sample},
];
sections.forEach(sec=>{
const items=voices.filter(sec.filter);if(!items.length)return;
const lbl=document.createElement('div');lbl.className='voice-section-label';lbl.textContent=sec.label;grid.appendChild(lbl);
const sDiv=document.createElement('div');sDiv.className='voice-section';
items.forEach(v=>{
const card=document.createElement('div');card.className='voice-card'+(v.id===selectedVoice?' selected':'');card.dataset.id=v.id;
card.innerHTML=`<div class="vc-info"><div class="vc-name">${v.name}</div><div class="vc-style">${v.style}</div></div>${v.sample?'<div class="vc-play" data-sample="'+v.id+'" title="Preview"><svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg></div>':''}`;
card.addEventListener('click',e=>{if(e.target.closest('.vc-play'))return;selectVoice(v.id)});
sDiv.appendChild(card)});grid.appendChild(sDiv)});
grid.addEventListener('click',e=>{const p=e.target.closest('.vc-play');if(!p)return;e.stopPropagation();const id=p.dataset.sample;
if(previewAudio){previewAudio.pause();previewAudio=null;document.querySelectorAll('.vc-play.playing').forEach(b=>b.classList.remove('playing'))}
previewAudio=new Audio('/samples/'+id+'.wav');p.classList.add('playing');previewAudio.play();
previewAudio.onended=()=>{p.classList.remove('playing');previewAudio=null}})
}

function selectVoice(id){selectedVoice=id;document.getElementById('voiceSelect').value=id;document.querySelectorAll('.voice-card').forEach(c=>c.classList.toggle('selected',c.dataset.id===id))}

document.getElementById('presets').addEventListener('click',e=>{const btn=e.target.closest('.preset-btn');if(!btn)return;document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');const p=btn.dataset.persona;document.getElementById('personaInput').value=p;if(p==='')document.getElementById('personaInput').focus()});

function initVisualizer(){const c=document.getElementById('visualizer');c.innerHTML='';for(let i=0;i<32;i++){const bar=document.createElement('div');bar.className='bar';c.appendChild(bar)}}
function animateVisualizer(){if(!isConnected)return;document.querySelectorAll('.visualizer .bar').forEach(bar=>{bar.style.height=(4+Math.random()*48)+'px'});requestAnimationFrame(()=>setTimeout(animateVisualizer,80))}
function startTimer(){callSeconds=0;updateTimerDisplay();timerInterval=setInterval(()=>{callSeconds++;updateTimerDisplay()},1000)}
function stopTimer(){clearInterval(timerInterval)}
function updateTimerDisplay(){const m=String(Math.floor(callSeconds/60)).padStart(2,'0'),s=String(callSeconds%60).padStart(2,'0');document.getElementById('timer').textContent=m+':'+s}
function setStatus(state,text){document.getElementById('statusDot').className='status-dot '+state;document.getElementById('statusText').textContent=text}

async function toggleCall(){
if(isConnected){endCall();return}
const btn=document.getElementById('connectBtn');btn.classList.add('connecting');btn.textContent='Connecting...';setStatus('connecting','Connecting...');
try{
mediaStream=await navigator.mediaDevices.getUserMedia({audio:true});
audioContext=new AudioContext({sampleRate:24000});
const source=audioContext.createMediaStreamSource(mediaStream);
scriptProcessor=audioContext.createScriptProcessor(4096,1,1);
const proto=location.protocol==='https:'?'wss:':'ws:';
ws=new WebSocket(proto+'//'+location.host+'/voice');
ws.onopen=()=>{ws.send(JSON.stringify({type:'start',voice:document.getElementById('voiceSelect').value,persona:document.getElementById('personaInput').value}))};
ws.onmessage=evt=>{if(typeof evt.data==='string'){const msg=JSON.parse(evt.data);if(msg.type==='connected'||msg.type==='session_created')onConnected();else if(msg.type==='error'){setStatus('error',msg.message||'Error');endCall()}else if(msg.type==='backend_disconnected'){setStatus('error','Backend disconnected');endCall()}}else playAudioData(evt.data)};
ws.onerror=()=>{setStatus('error','Connection failed');resetUI()};
ws.onclose=()=>{if(isConnected)endCall()};
scriptProcessor.onaudioprocess=e=>{if(!isMuted&&ws&&ws.readyState===WebSocket.OPEN){const input=e.inputBuffer.getChannelData(0);const pcm16=new Int16Array(input.length);for(let i=0;i<input.length;i++)pcm16[i]=Math.max(-32768,Math.min(32767,input[i]*32768));ws.send(pcm16.buffer)}};
source.connect(scriptProcessor);scriptProcessor.connect(audioContext.destination);
}catch(err){setStatus('error',err.message||'Microphone access denied');resetUI()}}

function onConnected(){isConnected=true;document.getElementById('setupCard').style.display='none';document.getElementById('callUI').classList.add('visible');
document.getElementById('callPersonaLabel').textContent=document.getElementById('personaInput').value.substring(0,60)+'...';
const v=voices.find(x=>x.id===selectedVoice);document.getElementById('callVoiceLabel').textContent=v?v.name:selectedVoice;
initVisualizer();animateVisualizer();startTimer()}

function endCall(){isConnected=false;if(ws){try{ws.close()}catch(e){}ws=null}if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop());mediaStream=null}if(scriptProcessor){scriptProcessor.disconnect();scriptProcessor=null}if(audioContext){audioContext.close();audioContext=null}stopTimer();isMuted=false;document.getElementById('muteBtn').classList.remove('muted');document.getElementById('callUI').classList.remove('visible');document.getElementById('setupCard').style.display='block';resetUI()}
function resetUI(){const btn=document.getElementById('connectBtn');btn.classList.remove('connecting','active');btn.textContent='Start Call';btn.disabled=false;setStatus('disconnected','Ready to connect')}
function toggleMute(){isMuted=!isMuted;document.getElementById('muteBtn').classList.toggle('muted',isMuted)}

async function playAudioData(data){if(!audioContext)return;try{const ab=data instanceof ArrayBuffer?data:await data.arrayBuffer();const pcm16=new Int16Array(ab);const f32=new Float32Array(pcm16.length);for(let i=0;i<pcm16.length;i++)f32[i]=pcm16[i]/32768;const buf=audioContext.createBuffer(1,f32.length,24000);buf.getChannelData(0).set(f32);const src=audioContext.createBufferSource();src.buffer=buf;src.connect(audioContext.destination);src.start()}catch(e){}}

populateVoices();
</script>
</body>
</html>
</content>
</invoke>