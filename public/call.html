<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClaw Voice — Call</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',system-ui,sans-serif;background:#0a0a0a;color:#f5f5f5;height:100vh;display:flex;flex-direction:column;overflow:hidden}

.topbar{padding:14px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.topbar-left{display:flex;align-items:center;gap:10px}
.topbar-logo{width:28px;height:28px;border-radius:7px;background:linear-gradient(135deg,rgb(245,124,0),rgb(230,81,0));display:flex;align-items:center;justify-content:center}
.topbar-logo svg{width:14px;height:14px;fill:#fff}
.topbar-title{font-size:14px;font-weight:600;color:#8e8e93}
.topbar-right{display:flex;align-items:center;gap:12px}
.status-dot{width:8px;height:8px;border-radius:50%;background:#555}
.status-dot.connected{background:#34c759}
.status-dot.connecting{background:rgb(245,124,0);animation:blink 1s infinite}
.status-dot.speaking{background:#5856d6;animation:blink .5s infinite}
.status-dot.error{background:#ff453a}
.status-label{font-size:13px;color:#636366}
.timer{font-size:13px;color:#8e8e93;font-variant-numeric:tabular-nums}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

.main{flex:1;display:flex;flex-direction:column;padding:0 24px;overflow:hidden}
.chat{flex:1;overflow-y:auto;padding:16px 0;display:flex;flex-direction:column;gap:16px;scroll-behavior:smooth}
.chat::-webkit-scrollbar{width:4px}
.chat::-webkit-scrollbar-thumb{background:#333;border-radius:2px}

.msg{display:flex;flex-direction:column;max-width:80%;animation:fadeIn .2s ease}
.msg.ai{align-self:flex-start;align-items:flex-start}
.msg-sender{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;padding:0 4px;color:#5856d6}
.msg-bubble{padding:14px 20px;border-radius:18px;font-size:17px;line-height:1.6;background:#1a1a2e;border-bottom-left-radius:4px;color:#e0e0e0}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

.pulse-wrap{display:flex;justify-content:center;padding:30px 0;flex-shrink:0}
.pulse-container{position:relative;width:120px;height:120px}
.pulse-ring{position:absolute;inset:0;border-radius:50%;border:2px solid rgba(245,124,0,.1)}
.pulse-ring.active{animation:ring 2s ease-out infinite}
.pulse-ring:nth-child(2){animation-delay:.5s}
.pulse-ring:nth-child(3){animation-delay:1s}
.pulse-core{position:absolute;inset:20px;border-radius:50%;background:linear-gradient(135deg,rgb(245,124,0),rgb(230,81,0));display:flex;align-items:center;justify-content:center;box-shadow:0 0 40px rgba(245,124,0,.15);transition:all .3s}
.pulse-core.speaking{transform:scale(1.1);box-shadow:0 0 60px rgba(88,86,214,.4);background:linear-gradient(135deg,#5856d6,#7c3aed)}
.pulse-core svg{width:32px;height:32px;fill:#fff}
@keyframes ring{0%{transform:scale(.8);opacity:.6}100%{transform:scale(1.6);opacity:0}}

.bottombar{padding:16px 24px 28px;display:flex;align-items:center;justify-content:center;gap:16px;flex-shrink:0}
.mic-btn{width:60px;height:60px;border-radius:50%;background:#1c1c1e;border:2px solid #333;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s}
.mic-btn:hover{background:#2a2a2e}
.mic-btn.active{background:rgba(52,199,89,.15);border-color:#34c759}
.mic-btn.active svg{color:#34c759}
.mic-btn.muted svg{color:#ff453a}
.mic-btn svg{width:24px;height:24px;color:#8e8e93}
.end-btn{padding:14px 40px;border-radius:50px;background:#ff453a;border:none;font-family:inherit;font-size:15px;font-weight:700;color:#fff;cursor:pointer;transition:all .15s}
.end-btn:hover{background:#dc2626;transform:scale(1.03)}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <div class="topbar-logo"><svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2" fill="none" stroke="#fff" stroke-width="2"/></svg></div>
    <span class="topbar-title">OpenClaw Voice</span>
  </div>
  <div class="topbar-right">
    <div class="status-dot connecting" id="statusDot"></div>
    <span class="status-label" id="statusLabel">Connecting...</span>
    <span class="timer" id="timer">00:00</span>
  </div>
</div>

<div class="main"><div class="chat" id="chat"></div></div>

<div class="pulse-wrap">
  <div class="pulse-container">
    <div class="pulse-ring active"></div>
    <div class="pulse-ring active"></div>
    <div class="pulse-ring active"></div>
    <div class="pulse-core" id="pulseCore"><svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2" fill="none" stroke="#fff" stroke-width="2"/></svg></div>
  </div>
</div>

<div class="bottombar">
  <button class="mic-btn active" id="micBtn" onclick="toggleMic()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
  </button>
  <button class="end-btn" onclick="endCall()">End Call</button>
</div>

<script>
// ===== CONFIG =====
const params = new URLSearchParams(location.search);
const voice = params.get('voice') || 'NATM2';
const persona = params.get('persona') || 'You are Nole, a sharp AI co-founder. Be concise and helpful.';
const PP_HOST = 'ymamku8yfkeqsu-8998.proxy.runpod.net';

let ppWs = null;
let micActive = true;
let isConnected = false;
let seconds = 0;
let timerInterval = null;

// Text accumulation
let currentText = '';
let textTimeout = null;

// Audio playback via MediaSource
let audioElement = null;
let mediaSource = null;
let sourceBuffer = null;
let audioQueue = [];
let msReady = false;

// Mic capture
let audioCtx = null;
let micStream = null;
let scriptNode = null;

// ===== CONNECT =====
function connect() {
  const url = `wss://${PP_HOST}/api/chat?voice_prompt=${encodeURIComponent(voice + '.pt')}&text_prompt=${encodeURIComponent(persona)}`;
  setStatus('connecting', 'Connecting...');
  
  ppWs = new WebSocket(url);
  ppWs.binaryType = 'arraybuffer';
  
  ppWs.onopen = () => {
    setStatus('connecting', 'Starting session...');
    // KEY: Send start control message [type=control(0x03), data=start(0x00)]
    ppWs.send(new Uint8Array([0x03, 0x00]).buffer);
  };
  
  ppWs.onmessage = (evt) => {
    const data = new Uint8Array(evt.data);
    if (data.length === 0) return;
    const kind = data[0];
    const payload = data.slice(1);
    
    if (kind === 0x00) {
      // Handshake received!
      isConnected = true;
      setStatus('connected', 'Connected — speak!');
      startTimer();
      initAudioPlayback();
      startMic();
      return;
    }
    
    if (kind === 0x01 && payload.length > 0) {
      // Audio chunk (Ogg/Opus from PersonaPlex)
      playAudioChunk(payload);
    }
    
    if (kind === 0x02) {
      // Text token
      handleTextToken(new TextDecoder().decode(payload));
    }
  };
  
  ppWs.onerror = () => setStatus('error', 'Connection error');
  ppWs.onclose = (e) => {
    if (isConnected) {
      setStatus('error', 'Disconnected (code ' + e.code + ')');
    } else {
      setStatus('error', 'Failed to connect');
    }
    isConnected = false;
  };
}

// ===== AUDIO PLAYBACK (MediaSource for streaming Ogg/Opus) =====
function initAudioPlayback() {
  // Try MediaSource for streaming playback
  if (window.MediaSource && MediaSource.isTypeSupported('audio/ogg; codecs=opus')) {
    audioElement = new Audio();
    mediaSource = new MediaSource();
    audioElement.src = URL.createObjectURL(mediaSource);
    
    mediaSource.addEventListener('sourceopen', () => {
      try {
        sourceBuffer = mediaSource.addSourceBuffer('audio/ogg; codecs=opus');
        sourceBuffer.mode = 'sequence';
        msReady = true;
        
        sourceBuffer.addEventListener('updateend', flushQueue);
        flushQueue();
      } catch(e) {
        console.warn('SourceBuffer error:', e);
        msReady = false;
      }
    });
    
    audioElement.play().catch(() => {});
  }
}

function playAudioChunk(chunk) {
  // Visual feedback
  document.getElementById('pulseCore').classList.add('speaking');
  clearTimeout(window._speakTimer);
  window._speakTimer = setTimeout(() => {
    document.getElementById('pulseCore').classList.remove('speaking');
  }, 1500);
  
  if (msReady && sourceBuffer) {
    audioQueue.push(chunk.buffer.slice(chunk.byteOffset, chunk.byteOffset + chunk.byteLength));
    flushQueue();
    if (audioElement.paused) audioElement.play().catch(() => {});
  }
}

function flushQueue() {
  if (!sourceBuffer || sourceBuffer.updating || audioQueue.length === 0) return;
  try {
    sourceBuffer.appendBuffer(audioQueue.shift());
  } catch(e) {
    console.warn('appendBuffer error:', e);
  }
}

// ===== TEXT HANDLING =====
function handleTextToken(text) {
  currentText += text;
  clearTimeout(textTimeout);
  textTimeout = setTimeout(() => {
    if (currentText.trim()) {
      addMessage(currentText.trim());
      currentText = '';
    }
  }, 1500);
}

// ===== MICROPHONE (PCM → send as raw audio with kind=0x01) =====
// PersonaPlex expects Ogg/Opus but let's try sending via MediaRecorder
let mediaRecorder = null;

async function startMic() {
  try {
    micStream = await navigator.mediaDevices.getUserMedia({ 
      audio: { sampleRate: 24000, channelCount: 1, echoCancellation: true, noiseSuppression: true } 
    });
    
    // Use MediaRecorder for Ogg/Opus encoding
    const mimeType = MediaRecorder.isTypeSupported('audio/ogg; codecs=opus') 
      ? 'audio/ogg; codecs=opus'
      : MediaRecorder.isTypeSupported('audio/webm; codecs=opus')
        ? 'audio/webm; codecs=opus' 
        : null;
    
    if (mimeType) {
      mediaRecorder = new MediaRecorder(micStream, { mimeType, audioBitsPerSecond: 24000 });
      
      mediaRecorder.ondataavailable = async (e) => {
        if (e.data.size > 0 && ppWs && ppWs.readyState === WebSocket.OPEN && micActive) {
          const buf = await e.data.arrayBuffer();
          const audioBytes = new Uint8Array(buf);
          // Wrap: [0x01 (audio kind), ...audio_data]
          const msg = new Uint8Array(1 + audioBytes.length);
          msg[0] = 0x01;
          msg.set(audioBytes, 1);
          ppWs.send(msg.buffer);
        }
      };
      
      mediaRecorder.start(100); // 100ms chunks
    }
  } catch(err) {
    console.warn('Mic error:', err.message);
    setStatus('connected', 'No mic — listen only');
  }
}

// ===== UI =====
function setStatus(state, text) {
  document.getElementById('statusDot').className = 'status-dot ' + state;
  document.getElementById('statusLabel').textContent = text;
}

function startTimer() {
  timerInterval = setInterval(() => {
    seconds++;
    const m = String(Math.floor(seconds/60)).padStart(2,'0');
    const s = String(seconds%60).padStart(2,'0');
    document.getElementById('timer').textContent = m+':'+s;
  }, 1000);
}

function addMessage(text) {
  const chat = document.getElementById('chat');
  const msg = document.createElement('div');
  msg.className = 'msg ai';
  const d = document.createElement('div');
  d.textContent = text;
  msg.innerHTML = '<div class="msg-sender">Nole</div>';
  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  bubble.textContent = text;
  msg.appendChild(bubble);
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
}

function toggleMic() {
  micActive = !micActive;
  const btn = document.getElementById('micBtn');
  if (micActive) {
    btn.className = 'mic-btn active';
    if (mediaRecorder && mediaRecorder.state === 'paused') mediaRecorder.resume();
  } else {
    btn.className = 'mic-btn muted';
    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.pause();
  }
}

function endCall() {
  if (ppWs) try { ppWs.close(); } catch(e) {}
  if (mediaRecorder) try { mediaRecorder.stop(); } catch(e) {}
  if (micStream) micStream.getTracks().forEach(t => t.stop());
  if (audioElement) audioElement.pause();
  clearInterval(timerInterval);
  window.location.href = '/';
}

// ===== GO =====
connect();
</script>
</body>
</html>
