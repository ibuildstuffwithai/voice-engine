<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PersonaPlex Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#fafafa;color:#1a1a1a;min-height:100vh}
a{color:#1a1a1a;text-decoration:none}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;padding:16px 32px;border-bottom:1px solid #e5e5e5;background:#fff}
.header-left{display:flex;align-items:center;gap:12px}
.logo{font-size:20px;font-weight:700;letter-spacing:-0.5px}
.status-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
.status-dot.running{background:#22c55e;box-shadow:0 0 6px #22c55e88}
.status-dot.stopped{background:#ef4444;box-shadow:0 0 6px #ef444488}
.status-dot.unknown{background:#a1a1aa}
.status-label{font-size:13px;color:#666;font-weight:500}
.header-nav{display:flex;gap:16px;align-items:center}
.header-nav a{font-size:13px;font-weight:500;color:#666;padding:6px 14px;border-radius:6px;transition:all .15s}
.header-nav a:hover{background:#f0f0f0;color:#1a1a1a}
.header-nav a.active{background:#1a1a1a;color:#fff}

/* Container */
.container{max-width:960px;margin:0 auto;padding:32px 24px}

/* Cards */
.card{background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:24px;margin-bottom:20px}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card-title{font-size:15px;font-weight:600;color:#1a1a1a}
.card-subtitle{font-size:12px;color:#888;margin-top:2px}

/* Stats Row */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px}
.stat-card{background:#fff;border:1px solid #e5e5e5;border-radius:10px;padding:16px 20px;text-align:center}
.stat-value{font-size:28px;font-weight:700;color:#1a1a1a}
.stat-value.running{color:#22c55e}
.stat-value.stopped{color:#ef4444}
.stat-value.cost{color:#f59e0b}
.stat-label{font-size:11px;color:#888;text-transform:uppercase;letter-spacing:.5px;margin-top:4px}

/* Info Grid */
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.info-item{display:flex;flex-direction:column;gap:2px}
.info-label{font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:#888;font-weight:600}
.info-value{font-size:14px;color:#1a1a1a;font-weight:500}
.info-value.mono{font-family:'SF Mono',Monaco,monospace;font-size:12px;color:#555}
.info-value a{color:#2563eb;font-weight:500}
.info-value a:hover{text-decoration:underline}

/* Buttons */
.btn{padding:10px 20px;border-radius:8px;border:1px solid #e5e5e5;font-size:13px;font-weight:600;cursor:pointer;font-family:'Inter',sans-serif;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{transform:translateY(-1px)}
.btn-primary{background:#1a1a1a;color:#fff;border-color:#1a1a1a}
.btn-primary:hover{background:#333}
.btn-danger{background:#fff;color:#ef4444;border-color:#fca5a5}
.btn-danger:hover{background:#fef2f2}
.btn-success{background:#fff;color:#22c55e;border-color:#86efac}
.btn-success:hover{background:#f0fdf4}
.btn-ghost{background:transparent;border-color:#e5e5e5;color:#555}
.btn-ghost:hover{background:#f5f5f5;color:#1a1a1a}
.btn-group{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}

/* Form */
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#888;margin-bottom:6px}
.form-input{width:100%;padding:10px 14px;border:1px solid #e5e5e5;border-radius:8px;font-size:13px;font-family:'Inter',sans-serif;color:#1a1a1a;background:#fff;transition:border .15s}
.form-input:focus{outline:none;border-color:#1a1a1a}
.form-input::placeholder{color:#bbb}
.input-with-btn{display:flex;gap:8px}
.input-with-btn .form-input{flex:1}
.input-with-btn .btn{padding:10px 14px;white-space:nowrap}

/* Alerts */
.alert{padding:12px 16px;border-radius:8px;font-size:13px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.alert-success{background:#f0fdf4;border:1px solid #86efac;color:#166534}
.alert-error{background:#fef2f2;border:1px solid #fca5a5;color:#991b1b}
.alert-info{background:#eff6ff;border:1px solid #93c5fd;color:#1e40af}

/* Quick Actions */
.quick-actions{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.quick-action{display:flex;flex-direction:column;align-items:center;gap:8px;padding:20px;border:1px solid #e5e5e5;border-radius:10px;cursor:pointer;transition:all .15s;background:#fff;text-decoration:none;color:#1a1a1a}
.quick-action:hover{border-color:#1a1a1a;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
.quick-action-icon{font-size:24px}
.quick-action-label{font-size:12px;font-weight:600;color:#555}

/* Responsive */
@media(max-width:640px){
  .stats-row{grid-template-columns:repeat(2,1fr)}
  .info-grid{grid-template-columns:1fr}
  .quick-actions{grid-template-columns:1fr}
  .header{padding:12px 16px;flex-wrap:wrap;gap:8px}
}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo">‚ö° PersonaPlex Manager</div>
    <span class="status-dot unknown" id="header-dot"></span>
    <span class="status-label" id="header-status">Checking...</span>
  </div>
  <div class="header-nav">
    <a href="/">Voice UI</a>
    <a href="/manage.html" class="active">Manager</a>
  </div>
</div>

<div class="container">
  <div id="alert-area"></div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-value" id="stat-status">‚Äî</div>
      <div class="stat-label">Pod Status</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-uptime">‚Äî</div>
      <div class="stat-label">Uptime</div>
    </div>
    <div class="stat-card">
      <div class="stat-value cost" id="stat-cost">‚Äî</div>
      <div class="stat-label">Est. Cost (Session)</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-gpu">‚Äî</div>
      <div class="stat-label">GPU</div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="card">
    <div class="card-header"><div class="card-title">Quick Actions</div></div>
    <div class="quick-actions">
      <a class="quick-action" id="qa-voice" href="#" onclick="openVoiceUI()">
        <div class="quick-action-icon">üéôÔ∏è</div>
        <div class="quick-action-label">Open Voice UI</div>
      </a>
      <a class="quick-action" id="qa-jupyter" href="#" onclick="openJupyter()">
        <div class="quick-action-icon">üíª</div>
        <div class="quick-action-label">Open Terminal</div>
      </a>
      <a class="quick-action" href="#" onclick="checkHealth()">
        <div class="quick-action-icon">ü©∫</div>
        <div class="quick-action-label">Health Check</div>
      </a>
    </div>
  </div>

  <!-- Pod Control -->
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Pod Control</div>
        <div class="card-subtitle">Start, stop, and monitor your RunPod GPU pod</div>
      </div>
    </div>
    <div class="info-grid" id="pod-info">
      <div class="info-item">
        <div class="info-label">Pod ID</div>
        <div class="info-value mono" id="pod-id">Not configured</div>
      </div>
      <div class="info-item">
        <div class="info-label">GPU</div>
        <div class="info-value" id="pod-gpu">‚Äî</div>
      </div>
      <div class="info-item">
        <div class="info-label">Server URL</div>
        <div class="info-value" id="pod-url">‚Äî</div>
      </div>
      <div class="info-item">
        <div class="info-label">Datacenter</div>
        <div class="info-value" id="pod-dc">‚Äî</div>
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-success" onclick="startPod()">‚ñ∂ Start Pod</button>
      <button class="btn btn-danger" onclick="stopPod()">‚èπ Stop Pod</button>
      <button class="btn btn-ghost" onclick="refreshStatus()">‚Üª Refresh</button>
    </div>
  </div>

  <!-- Settings -->
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">‚öôÔ∏è Settings</div>
        <div class="card-subtitle">API keys and configuration ‚Äî stored locally in your browser</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">RunPod API Key</label>
      <div class="input-with-btn">
        <input class="form-input" id="s-runpod" type="password" placeholder="rpa_...">
        <button class="btn btn-ghost" onclick="toggleVis('s-runpod')">üëÅ</button>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">HuggingFace Token</label>
      <div class="input-with-btn">
        <input class="form-input" id="s-hf" type="password" placeholder="hf_...">
        <button class="btn btn-ghost" onclick="toggleVis('s-hf')">üëÅ</button>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Pod ID</label>
      <input class="form-input" id="s-podid" type="text" placeholder="e.g. ymamku8yfkeqsu">
    </div>
    <div class="form-group">
      <label class="form-label">PersonaPlex Server URL (auto-generated from Pod ID)</label>
      <input class="form-input" id="s-server" type="text" placeholder="https://xxxxx-8998.proxy.runpod.net">
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
      <button class="btn btn-ghost" onclick="loadSettings()">Reset</button>
    </div>
  </div>

  <!-- Logs -->
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Activity Log</div>
        <div class="card-subtitle">Recent actions and events</div>
      </div>
      <button class="btn btn-ghost" onclick="clearLogs()" style="font-size:11px">Clear</button>
    </div>
    <div id="logs" style="font-family:'SF Mono',Monaco,monospace;font-size:12px;color:#555;max-height:200px;overflow-y:auto;line-height:1.8"></div>
  </div>
</div>

<script>
const STORAGE_KEY = 'personaplex_settings';
const COST_PER_HOUR = 0.40;
let pollInterval = null;

// Settings
function loadSettings() {
  const s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  document.getElementById('s-runpod').value = s.runpodKey || '';
  document.getElementById('s-hf').value = s.hfToken || '';
  document.getElementById('s-podid').value = s.podId || '';
  document.getElementById('s-server').value = s.serverUrl || '';
  return s;
}

function saveSettings() {
  const podId = document.getElementById('s-podid').value.trim();
  const s = {
    runpodKey: document.getElementById('s-runpod').value.trim(),
    hfToken: document.getElementById('s-hf').value.trim(),
    podId,
    serverUrl: document.getElementById('s-server').value.trim() || (podId ? `https://${podId}-8998.proxy.runpod.net` : ''),
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
  addLog('Settings saved');
  showAlert('Settings saved successfully', 'success');
  // Auto-fill server URL
  if (podId && !document.getElementById('s-server').value.trim()) {
    document.getElementById('s-server').value = `https://${podId}-8998.proxy.runpod.net`;
  }
  refreshStatus();
}

function getSettings() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
}

function toggleVis(id) {
  const el = document.getElementById(id);
  el.type = el.type === 'password' ? 'text' : 'password';
}

// Auto-fill server URL when pod ID changes
document.getElementById('s-podid').addEventListener('input', function() {
  const podId = this.value.trim();
  if (podId) {
    document.getElementById('s-server').value = `https://${podId}-8998.proxy.runpod.net`;
  }
});

// RunPod API
async function runpodQuery(query) {
  const s = getSettings();
  if (!s.runpodKey) { showAlert('RunPod API key not set ‚Äî go to Settings', 'error'); return null; }
  try {
    const r = await fetch('https://api.runpod.io/graphql', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + s.runpodKey, 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });
    const data = await r.json();
    if (data.errors) { showAlert('RunPod API error: ' + data.errors[0].message, 'error'); return null; }
    return data.data;
  } catch (e) {
    showAlert('Failed to reach RunPod API: ' + e.message, 'error');
    return null;
  }
}

async function refreshStatus() {
  const s = getSettings();
  if (!s.podId || !s.runpodKey) {
    updateUI(null);
    return;
  }
  addLog('Checking pod status...');
  const data = await runpodQuery(`query { pod(input: { podId: "${s.podId}" }) { id name desiredStatus runtime { uptimeInSeconds gpus { id gpuUtilPercent memoryUtilPercent } } machine { gpuDisplayName dataCenterId } } }`);
  if (data && data.pod) {
    updateUI(data.pod);
    addLog(`Pod status: ${data.pod.desiredStatus}`);
  } else {
    updateUI(null);
  }
}

function updateUI(pod) {
  const dot = document.getElementById('header-dot');
  const label = document.getElementById('header-status');
  const statStatus = document.getElementById('stat-status');
  const statUptime = document.getElementById('stat-uptime');
  const statCost = document.getElementById('stat-cost');
  const statGpu = document.getElementById('stat-gpu');

  if (!pod) {
    dot.className = 'status-dot unknown';
    label.textContent = 'Not configured';
    statStatus.textContent = '‚Äî';
    statStatus.className = 'stat-value';
    statUptime.textContent = '‚Äî';
    statCost.textContent = '‚Äî';
    statGpu.textContent = '‚Äî';
    return;
  }

  const running = pod.desiredStatus === 'RUNNING' && pod.runtime;
  dot.className = 'status-dot ' + (running ? 'running' : 'stopped');
  label.textContent = running ? 'Running' : pod.desiredStatus;
  
  statStatus.textContent = running ? 'Running' : pod.desiredStatus;
  statStatus.className = 'stat-value ' + (running ? 'running' : 'stopped');

  if (running && pod.runtime?.uptimeInSeconds) {
    const h = Math.floor(pod.runtime.uptimeInSeconds / 3600);
    const m = Math.floor((pod.runtime.uptimeInSeconds % 3600) / 60);
    statUptime.textContent = h > 0 ? `${h}h ${m}m` : `${m}m`;
    statCost.textContent = `$${(pod.runtime.uptimeInSeconds / 3600 * COST_PER_HOUR).toFixed(2)}`;
  } else {
    statUptime.textContent = '‚Äî';
    statCost.textContent = '$0.00';
  }

  const gpuName = pod.machine?.gpuDisplayName || '‚Äî';
  statGpu.textContent = gpuName;
  document.getElementById('pod-id').textContent = pod.id;
  document.getElementById('pod-gpu').textContent = gpuName;
  document.getElementById('pod-dc').textContent = pod.machine?.dataCenterId || '‚Äî';

  const s = getSettings();
  const url = s.serverUrl || `https://${pod.id}-8998.proxy.runpod.net`;
  document.getElementById('pod-url').innerHTML = running ? `<a href="${url}" target="_blank">${url}</a>` : '‚Äî';
}

async function startPod() {
  const s = getSettings();
  if (!s.podId) { showAlert('Pod ID not set', 'error'); return; }
  addLog('Starting pod...');
  const data = await runpodQuery(`mutation { podResume(input: { podId: "${s.podId}", gpuCount: 1 }) { id desiredStatus } }`);
  if (data) {
    showAlert('Pod starting ‚Äî may take 1-2 minutes', 'success');
    addLog('Pod start requested');
    setTimeout(refreshStatus, 5000);
    setTimeout(refreshStatus, 15000);
    setTimeout(refreshStatus, 30000);
  }
}

async function stopPod() {
  const s = getSettings();
  if (!s.podId) { showAlert('Pod ID not set', 'error'); return; }
  if (!confirm('Stop the pod? PersonaPlex will go offline.')) return;
  addLog('Stopping pod...');
  const data = await runpodQuery(`mutation { podStop(input: { podId: "${s.podId}" }) { id desiredStatus } }`);
  if (data) {
    showAlert('Pod stopped ‚Äî you\'ll only pay for storage now', 'success');
    addLog('Pod stopped');
    setTimeout(refreshStatus, 3000);
  }
}

async function checkHealth() {
  const s = getSettings();
  const url = s.serverUrl;
  if (!url) { showAlert('Server URL not configured', 'error'); return; }
  addLog('Health check: ' + url);
  try {
    const r = await fetch(url, { mode: 'no-cors' });
    showAlert('PersonaPlex server is reachable ‚úì', 'success');
    addLog('Health check passed');
  } catch (e) {
    showAlert('Cannot reach PersonaPlex server ‚Äî may be offline or still starting', 'error');
    addLog('Health check failed: ' + e.message);
  }
}

function openVoiceUI() {
  const s = getSettings();
  const url = s.serverUrl;
  if (url) window.open(url, '_blank');
  else showAlert('Server URL not configured', 'error');
}

function openJupyter() {
  const s = getSettings();
  if (s.podId) window.open(`https://${s.podId}-8888.proxy.runpod.net`, '_blank');
  else showAlert('Pod ID not configured', 'error');
}

// Alerts
function showAlert(msg, type) {
  const area = document.getElementById('alert-area');
  const el = document.createElement('div');
  el.className = 'alert alert-' + type;
  el.innerHTML = (type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è') + ' ' + msg;
  area.prepend(el);
  setTimeout(() => el.remove(), 5000);
}

// Logs
function addLog(msg) {
  const logs = document.getElementById('logs');
  const time = new Date().toLocaleTimeString();
  logs.innerHTML = `<div>${time} ‚Äî ${msg}</div>` + logs.innerHTML;
}

function clearLogs() {
  document.getElementById('logs').innerHTML = '';
}

// Init
loadSettings();
refreshStatus();
// Poll every 30s
pollInterval = setInterval(refreshStatus, 30000);
</script>
</body>
</html>
